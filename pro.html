<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Professionista</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Inter', sans-serif; }
    .client-table th, .client-table td { padding: 1rem 1.5rem; }
    .client-table th { border-bottom: 2px solid #e5e7eb; }
    .client-card { transition: transform 0.2s, box-shadow 0.2s; }
    .client-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
    .tab-button.active { border-bottom: 3px solid #4f46e5; color: #4f46e5; font-weight: 600; }
    .main-tab-button.active { border-bottom: 3px solid #4f46e5; color: #4f46e5; font-weight: 600; }
    
    /* Drag and drop styles */
    .drop-zone {
      border: 3px dashed #cbd5e1;
      border-radius: 12px;
      padding: 3rem;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }
    .drop-zone:hover {
      border-color: #6366f1;
      background-color: #f8fafc;
    }
    .drop-zone.dragover {
      border-color: #4f46e5;
      background-color: #eef2ff;
    }
    .file-item {
      transition: all 0.2s;
    }
    .file-item:hover {
      background-color: #f8fafc;
    }
    /* Disable inputs when error modal is shown */
    body.error-active input,
    body.error-active textarea,
    body.error-active select {
        pointer-events: none;
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    /* Loading spinner */
    #loading-spinner {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
    }
    #loading-spinner.active {
        display: flex;
    }
    .spinner {
        width: 60px;
        height: 60px;
        border: 5px solid #f3f4f6;
        border-top: 5px solid #2563eb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* View transitions */
    #app {
        transition: opacity 0.3s ease-in-out;
    }
    #app.transitioning {
        opacity: 0;
    }
    
    /* Disable interaction during loading */
    body.loading-active {
        pointer-events: none;
    }
    body.loading-active #loading-spinner {
        pointer-events: auto;
    }
</style>
    <!-- PDF.js (necessario per leggere PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <!-- JSZip (necessario per leggere file docx/xlsx come zip) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
<div id="loading-spinner">
    <div class="spinner"></div>
</div>
<div id="app" class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto">
  <div id="loading-indicator" class="text-center py-10 bg-white rounded-xl shadow">
    <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="mt-4 text-gray-600">Caricamento dashboard...</p>
  </div>
</div>

<div id="error-modal" class="fixed inset-0 bg-red-800 bg-opacity-75 hidden items-center justify-center z-[100]">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
    <h3 class="text-xl font-bold mb-4 text-red-600">Errore Critico</h3>
    <p id="error-message" class="mb-4 text-gray-700">Si è verificato un errore.</p>
    <button onclick="window.location.href='index.html'" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">Torna al Login</button>
  </div>
</div>

<script src="config.js"></script>
<script type="module">
// API Persistence with data.json
// Uses PHP API (api.php) for server-side storage with data.json
// Allows multi-device access and data synchronization

const API_URL = 'api.php';

// API call to server using data.json
async function apiCall(method, params = {}) {
  try {
    const options = {
      method: method,
      headers: { 'Content-Type': 'application/json' }
    };
    
    if (method === 'GET') {
      const query = new URLSearchParams(params).toString();
      const response = await fetch(`${API_URL}?${query}`, options);
      const result = await response.json();
      return result;
    } else {
      options.body = JSON.stringify(params);
      const response = await fetch(API_URL, options);
      const result = await response.json();
      return result;
    }
  } catch (error) {
    console.error('Errore API:', error);
    return { success: false, error: error.message };
  }
}

async function standardizeWorkoutWithGemini(textContent) {
  showSpinner();
  try {
    const prompt = `You are a helpful assistant that converts workout plans to a standardized JSON format.
The output must be a JSON array where each object has these fields:
- day: string (e.g., "GIORNO A", "LUNEDÌ", "DAY 1")
- exercise: string (name of the exercise)
- sets: number (number of sets, default to 0 if not specified)
- reps: number (number of reps, default to 0 if not specified)
- load: string (weight/load, default to "N/D" if not specified)

Convert any workout plan format (text, CSV, table, etc.) to this JSON format. All text values should be in UPPERCASE.

Here is the workout plan to convert:
${textContent}`;

    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        contents: [
          {
            parts: [
              {
                text: prompt
              }
            ]
          }
        ]
      })
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      const errorMessage = errorData.error || `Gemini API error: ${response.status}`;
      throw new Error(errorMessage);
    }

    const data = await response.json();
    const content = data.candidates[0].content.parts[0].text;
    
    // Extract JSON from response (might be wrapped in markdown code blocks)
    let jsonText = content;
    if (content.includes('```json')) {
      jsonText = content.match(/```json\n([\s\S]*?)\n```/)[1];
    } else if (content.includes('```')) {
      jsonText = content.match(/```\n([\s\S]*?)\n```/)[1];
    }
    
    return JSON.parse(jsonText);
  } catch (error) {
    console.error('Error standardizing workout with Gemini:', error);
    throw new Error('Impossibile standardizzare il piano con Gemini: ' + error.message);
  } finally {
    hideSpinner();
  }
}

async function standardizeDietWithGemini(textContent) {
  showSpinner();
  try {
    const prompt = `You are a helpful assistant that converts diet plans to a standardized JSON format.
The output must be a JSON array where each object represents a day with these fields:
- day: string (e.g., "LUNEDÌ", "MARTEDÌ", etc. - must be one of: LUNEDÌ, MARTEDÌ, MERCOLEDÌ, GIOVEDÌ, VENERDÌ, SABATO, DOMENICA)
- meals: array of meal objects, each with:
  - category: string (meal type, e.g., "COLAZIONE", "PRANZO", "CENA", "SPUNTINO")
  - description: string (food description)
  - weight: string (portion size, e.g., "150G", "200ML")
  - type: string (food type/category, e.g., "RICETTA", "INTEGRATORE", "PROTEINA")
  - calories: number (calories for this meal)

Convert any diet plan format (text, CSV, table, etc.) to this JSON format. All text values should be in UPPERCASE.

Here is the diet plan to convert:
${textContent}`;

    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        contents: [
          {
            parts: [
              {
                text: prompt
              }
            ]
          }
        ]
      })
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      const errorMessage = errorData.error || `Gemini API error: ${response.status}`;
      throw new Error(errorMessage);
    }

    const data = await response.json();
    const content = data.candidates[0].content.parts[0].text;
    
    // Extract JSON from response (might be wrapped in markdown code blocks)
    let jsonText = content;
    if (content.includes('```json')) {
      jsonText = content.match(/```json\n([\s\S]*?)\n```/)[1];
    } else if (content.includes('```')) {
      jsonText = content.match(/```\n([\s\S]*?)\n```/)[1];
    }
    
    return JSON.parse(jsonText);
  } catch (error) {
    console.error('Error standardizing diet with Gemini:', error);
    throw new Error('Impossibile standardizzare il piano dieta con Gemini: ' + error.message);
  } finally {
    hideSpinner();
  }
}

// Simple hash function
function simpleHash(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  return hash;
}

// Loading spinner functions
function showSpinner() {
  const spinner = document.getElementById('loading-spinner');
  if (spinner) {
    spinner.classList.add('active');
    document.body.classList.add('loading-active');
  }
}

function hideSpinner() {
  const spinner = document.getElementById('loading-spinner');
  if (spinner) {
    spinner.classList.remove('active');
    document.body.classList.remove('loading-active');
  }
}

const proApp = {
  user: null,
  data: {},
  clientsData: {},
  editingClient: null,
  currentClientView: 'workout', // Nuova variabile per la scheda del modale
  currentMainView: 'clients', // Nuova variabile per la scheda principale
  editingWorkoutId: null, // Per tracciare quale esercizio è in modifica
  editingDietMeal: null, // Per tracciare quale pasto è in modifica (formato: {dayIndex, mealIndex})
  migrationFiles: [], // Files for migration
  migrationResults: [], // Results of migration

  showError(message) {
    const loading = document.getElementById('loading-indicator');
    if (loading) loading.classList.add('hidden');
    const em = document.getElementById('error-message');
    if (em) em.textContent = message;
    const m = document.getElementById('error-modal');
    if (m) { m.classList.remove('hidden'); m.classList.add('flex'); }
    document.body.classList.add('error-active');
    console.error('Errore Critico:', message);
  },

  async init() {
    try {
      await this.setupAuth();
    } catch (e) {
      this.showError("Errore inizializzazione: " + (e.message || e));
      console.error(e);
    }
  },

  async setupAuth() {
    const loadingIndicator = document.getElementById('loading-indicator');
    if (loadingIndicator) loadingIndicator.classList.add('hidden');

    // Check localStorage for current user
    const savedUser = localStorage.getItem('currentUser');
    if (!savedUser) {
      this.showError("Sessione scaduta. Effettua nuovamente il login.");
      return;
    }
    
    const user = JSON.parse(savedUser);
    this.user = { uid: user.uid };
    await this.initDashboard();
  },

  async initDashboard() {
    if (!this.user) return;
    try {
      const result = await apiCall('GET', { userId: this.user.uid });
      
      // Check if data exists (user might be in localStorage but not in data.json)
      if (!result || !result.data) {
        this.showError("Utente non trovato nel database. La sessione potrebbe essere scaduta o non sincronizzata.");
        localStorage.removeItem('currentUser');
        return;
      }
      
      // Check if user is a professional
      if (result.data.userType !== "pro") {
        this.showError("Accesso non autorizzato. Il tuo account non è un account professionista.");
        localStorage.removeItem('currentUser');
        return;
      }
      
      this.data = result.data;
      await this.loadClientsData();
      this.render();
    } catch (err) {
      console.error("Errore initDashboard:", err);
      this.showError("Errore caricamento dati: " + (err.message || err));
    }
  },

  async loadClientsData() {
    this.clientsData = {};
    const clients = this.data.clients || [];
    for (const client of clients) {
      try {
        const result = await apiCall('GET', { userId: client.uid });
        if (result.success && result.data) {
          this.clientsData[client.uid] = { ...result.data, uid: client.uid };
        }
      } catch (e) {
        console.error(`Impossibile caricare i dati per il cliente ${client.uid}:`, e);
      }
    }
  },

  getLastDate(arr) {
    if (!arr) return '—';
    if (Array.isArray(arr) && arr.length === 0) return '—';
    if (Array.isArray(arr)) {
      const last = arr[arr.length - 1];
      return last?.updatedAt ? new Date(last.updatedAt).toLocaleDateString('it-IT') : (last?.date || last?.day || 'N/D');
    }
    return '—';
  },

  getWorkoutLastDate(clientData) {
    if (!clientData) return '—';
    if (clientData.workoutUpdatedAt) {
      return new Date(clientData.workoutUpdatedAt).toLocaleDateString('it-IT');
    }
    // Fallback to old behavior if no updatedAt field
    if (Array.isArray(clientData.workout) && clientData.workout.length > 0) {
      return 'N/D';
    }
    return '—';
  },

  getDietLastDate(clientData) {
    if (!clientData?.dietPlan) return '—';
    if (clientData.dietPlan.updatedAt) {
      return new Date(clientData.dietPlan.updatedAt).toLocaleDateString('it-IT');
    }
    // Fallback to old behavior if no updatedAt field
    if (Array.isArray(clientData.dietPlan.plan) && clientData.dietPlan.plan.length > 0) {
      return 'N/D';
    }
    return '—';
  },

  render() {
  const clientsCount = (this.data.clients || []).length;
  const displayName = this.data.displayUsername || this.user.displayName || this.user.email || "Professionista";

  document.getElementById('app').innerHTML = `
    <header class="mb-10 flex flex-col sm:flex-row justify-between items-start sm:items-center">
      <div>
        <h1 class="text-4xl font-extrabold text-gray-900">
          Dashboard Professionista
        </h1>
        <p class="text-lg text-gray-600 mt-1">
          Benvenuto <span class="font-semibold text-indigo-600">${displayName}</span>
        </p>
      </div>
      <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 mt-4 sm:mt-0">
        <button onclick="proApp.openAddClientModal()" 
          class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-6 py-2 rounded-lg shadow-md transition duration-150">
          + Nuovo Utente
        </button>
        <button onclick="proApp.signOut()" 
          class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium px-6 py-2 rounded-lg transition duration-150">
          Logout
        </button>
      </div>
    </header>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
        <p class="text-sm font-medium text-gray-500">Totale Utenti Gestiti</p>
        <p class="text-3xl font-bold text-gray-900 mt-1">${clientsCount}</p>
      </div>
    </div>
    
    <div class="mb-8">
      <div class="flex border-b border-gray-200 bg-white rounded-t-xl shadow">
        <button onclick="proApp.setMainView('clients')" class="main-tab-button px-6 py-4 text-gray-600 hover:text-indigo-600 transition duration-150 ${this.currentMainView === 'clients' ? 'active' : ''}">Elenco Utenti</button>
        <button onclick="proApp.setMainView('migration')" class="main-tab-button px-6 py-4 text-gray-600 hover:text-indigo-600 transition duration-150 ${this.currentMainView === 'migration' ? 'active' : ''}">Migrazione</button>
      </div>
      <div id="main-content" class="bg-white shadow-xl rounded-b-xl">
        ${this.renderMainContent()}
      </div>
    </div>
    ${this.renderAddClientModal()}
    ${this.renderEditClientModal()}
  `;
},

  renderClientList() {
    const clients = this.data.clients || [];
    if (!clients.length) return '<p class="text-gray-500 italic p-6">Ancora nessun utente registrato. Clicca "Nuovo Utente" per iniziare.</p>';
    return `<div class="p-4 grid grid-cols-1 gap-4">
      ${clients.map(c => {
        const cd = this.clientsData[c.uid] || {};
        return `
          <div class="client-card bg-white border border-gray-100 rounded-lg shadow-sm p-4 flex flex-col md:flex-row justify-between items-start md:items-center">
            <div class="flex-grow">
              <p class="text-lg font-semibold text-gray-800">${c.username}</p>
              <ul class="text-xs text-gray-600 mt-1">
                <li>Ultima Configurazione: ${this.getLastDate(cd?.data?.measurementsLog)}</li>
              </ul>
            </div>
            <div class="flex flex-wrap gap-2 mt-3 md:mt-0 md:ml-4">
              <button onclick="proApp.openEditClientModal('${c.uid}')" class="text-indigo-600 border border-indigo-600 px-3 py-1 text-sm rounded-lg">Gestisci Dati</button>
              <button onclick="proApp.removeClient('${c.uid}')" class="bg-red-500 text-white px-3 py-1 text-sm rounded-lg">Rimuovi</button>
            </div>
          </div>`;
      }).join('')}
    </div>`;
  },

  renderMainContent() {
    switch(this.currentMainView) {
      case 'clients':
        return `<div class="p-6 border-b border-gray-100">
            <h2 class="text-2xl font-semibold text-gray-800">Elenco Utenti</h2>
        </div>
        ${this.renderClientList()}`;
      case 'migration':
        return this.renderMigrationView();
      default:
        return '<p class="p-6 text-gray-500">Seleziona una scheda.</p>';
    }
  },

  setMainView(view) {
    this.currentMainView = view;
    this.render();
  },

  renderMigrationView() {
    return `<div class="p-6">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">Migrazione Utenti</h2>
      <p class="text-sm text-gray-600 mb-6">Carica uno o più file (PDF, DOCX, XLS, XLSX, DOC, TXT) contenenti i dati degli utenti. Il sistema utilizzerà Gemini per estrarre automaticamente i dati e creare gli account.</p>
      
      <div id="drop-zone" class="drop-zone mb-6" 
           ondrop="proApp.handleDrop(event)" 
           ondragover="proApp.handleDragOver(event)" 
           ondragleave="proApp.handleDragLeave(event)"
           onclick="document.getElementById('file-input-migration').click()">
        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
          <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <p class="mt-2 text-sm text-gray-600">
          <span class="font-semibold text-indigo-600">Clicca per selezionare</span> o trascina i file qui
        </p>
        <p class="mt-1 text-xs text-gray-500">PDF, DOCX, XLS, XLSX, DOC, TXT</p>
      </div>
      <input type="file" id="file-input-migration" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.txt" class="hidden" onchange="proApp.handleFileSelect(event)">
      
      ${this.migrationFiles.length > 0 ? `
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3">File Selezionati (${this.migrationFiles.length})</h3>
          <div class="space-y-2">
            ${this.migrationFiles.map((file, index) => `
              <div class="file-item flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                <div class="flex items-center space-x-3">
                  <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <div>
                    <p class="text-sm font-medium text-gray-900">${file.name}</p>
                    <p class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)} KB</p>
                  </div>
                </div>
                <button onclick="proApp.removeFile(${index})" class="text-red-500 hover:text-red-700 transition">
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            `).join('')}
          </div>
          <div class="flex space-x-3 mt-4">
            <button onclick="proApp.startMigration()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-6 py-3 rounded-lg shadow-md transition duration-150">
              Inizia Migrazione
            </button>
            <button onclick="proApp.clearFiles()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-3 rounded-lg transition duration-150">
              Cancella Tutto
            </button>
          </div>
        </div>
      ` : ''}
      
      ${this.migrationResults.length > 0 ? `
        <div class="mt-6">
          <h3 class="text-lg font-semibold mb-3">Risultati Migrazione</h3>
          <div class="space-y-2">
            ${this.migrationResults.map(result => `
              <div class="p-4 border rounded-lg ${result.success ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                <div class="flex items-start space-x-3">
                  ${result.success ? `
                    <svg class="h-6 w-6 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  ` : `
                    <svg class="h-6 w-6 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  `}
                  <div class="flex-1">
                    <p class="font-medium ${result.success ? 'text-green-800' : 'text-red-800'}">${result.filename}</p>
                    <p class="text-sm ${result.success ? 'text-green-600' : 'text-red-600'} mt-1">${result.message}</p>
                    ${result.username ? `<p class="text-xs text-gray-600 mt-1">Username: ${result.username}</p>` : ''}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
          <button onclick="proApp.clearMigrationResults()" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-4 py-2 rounded-lg transition duration-150">
            Chiudi Risultati
          </button>
        </div>
      ` : ''}
    </div>`;
  },

  renderAddClientModal() {
    return `<div id="add-client-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
        <h3 class="text-2xl font-bold mb-5">Crea Nuovo Utente</h3>
        <form onsubmit="event.preventDefault(); proApp.addClient(this.username.value, this.password.value);">
          <input name="username" type="text" placeholder="Nome Utente (es. MARIO_ROSSI)" class="mb-3 w-full p-3 border rounded-lg" required>
          <input name="password" type="password" placeholder="Password (min. 6 caratteri)" class="mb-6 w-full p-3 border rounded-lg" required minlength="6">
          <div class="flex justify-end space-x-3">
            <button type="button" onclick="proApp.closeAddClientModal()" class="bg-gray-200 px-5 py-2 rounded-lg">Annulla</button>
            <button type="submit" class="bg-green-600 text-white px-5 py-2 rounded-lg">Crea Account</button>
          </div>
        </form>
      </div>
    </div>`;
  },

  /* MODIFICA IL MODALE DI EDITING: ORA È UN MODALE MULTI-SCHEDA */
  renderEditClientModal() {
    return `<div id="edit-client-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-5xl max-h-[95vh] flex flex-col">
        <h3 id="edit-client-title" class="text-2xl font-bold mb-2 text-gray-800">Gestione Dati Cliente</h3>
        <p class="text-sm text-gray-500 mb-5 border-b pb-3">Modifica i dati di allenamento, dieta o misure.</p>
        
        <div class="flex border-b border-gray-200 mb-4">
            <button onclick="proApp.setClientView('workout')" class="tab-button p-4 text-gray-600 hover:text-indigo-600 transition duration-150 ${this.currentClientView === 'workout' || this.currentClientView === 'workoutImport' ? 'active' : ''}">Allenamento</button>
            <button onclick="proApp.setClientView('diet')" class="tab-button p-4 text-gray-600 hover:text-indigo-600 transition duration-150 ${this.currentClientView === 'diet' || this.currentClientView === 'dietImport' ? 'active' : ''}">Dieta</button>
            <button onclick="proApp.setClientView('measurements')" class="tab-button p-4 text-gray-600 hover:text-indigo-600 transition duration-150 ${this.currentClientView === 'measurements' ? 'active' : ''}">Misure</button>
            <button onclick="proApp.setClientView('advanced')" class="tab-button p-4 text-gray-600 hover:text-indigo-600 transition duration-150 ${this.currentClientView === 'advanced' ? 'active' : ''}">Avanzate (JSON)</button>
        </div>

        <div id="edit-client-content" class="flex-grow overflow-y-auto">
          </div>

        <div class="flex justify-end mt-4 pt-4 border-t">
          <button type="button" onclick="proApp.closeEditClientModal()" class="bg-gray-200 hover:bg-gray-300 px-5 py-2 rounded-lg text-gray-800">Chiudi</button>
        </div>
      </div>
    </div>`;
  },
  openAddClientModal(){ const m = document.getElementById('add-client-modal'); if (m){ m.classList.remove('hidden'); m.classList.add('flex'); } },
  closeAddClientModal(){ const m = document.getElementById('add-client-modal'); if (m){ m.classList.add('hidden'); m.classList.remove('flex'); } },

  async addClient(username, password) {
    if (!this.user) return alert("Errore: professionista non autenticato.");
    const proUid = this.user.uid;
    const userKey = String(username || '').trim().toLowerCase();
    if (!userKey) return alert("Inserisci un nome utente valido.");
    const newClientUsername = userKey.toUpperCase();
    const clientId = 'client_' + Date.now() + '_' + Math.floor(Math.random()*10000);
    // If no password provided, use username as default password
    const actualPassword = (password && password.trim()) ? password : userKey;
    const passwordHash = simpleHash(actualPassword).toString();

    try {
      // 1) crea documento "utente" 
      const userData = {
        userType: "user",
        displayUsername: newClientUsername,
        passwordHash: passwordHash,
        uid: clientId,
        data: {
          habits: [],
          workout: [],
          uploadedWorkoutPlans: [],
          diet: [],
          dietPlan: { targetCalories: 2000, plan: [] },
          uploadedDietPlans: [],
          dailyCompliance: {},
          measurementsLog: []
        },
        sleepStartTimestamp: null,
        createdBy: proUid,
        createdAt: new Date().toISOString()
      };
      
      await apiCall('POST', { userId: clientId, data: userData });

      // 2) associa l'utente alla lista clients del professionista
      this.data.clients = this.data.clients || [];
      this.data.clients.push({ uid: clientId, username: newClientUsername });
      
      await apiCall('POST', { userId: proUid, data: this.data });

      // 3) ricarica e mostra
      await this.loadClientsData();
      this.render();
      this.closeAddClientModal();
      alert(`Utente '${newClientUsername}' creato e associato con successo!`);
    } catch (err) {
      console.error("Errore creazione utente:", { code: err?.code, message: err?.message, stack: err?.stack, raw: err });
      alert("Errore durante la creazione dell'utente.\nCodice: " + (err?.code || 'N/A') + "\nMessaggio: " + (err?.message || String(err)));
    }
  },

  async removeClient(uid) {
    if (!confirm("Sei sicuro di voler rimuovere questo utente?")) return;
    this.data.clients = (this.data.clients || []).filter(c => c.uid !== uid);
    delete this.clientsData[uid];
    try {
      await apiCall('POST', { userId: this.user.uid, data: this.data });
      this.render();
      alert("Utente rimosso dalla tua lista.");
    } catch (err) {
      console.error("Errore removeClient:", err);
      alert("Errore durante la rimozione: " + (err?.message || err));
    }
  },

  openEditClientModal(uid) {
    const clientData = this.clientsData[uid];
    if (!clientData) return alert("Dati del cliente non trovati.");
    this.editingClient = uid;
    document.getElementById('edit-client-title').textContent = `Modifica dati per: ${clientData.displayUsername}`;
    document.getElementById('edit-json-area').value = JSON.stringify(clientData, null, 2);
    const modal = document.getElementById('edit-client-modal');
    modal.classList.remove('hidden'); modal.classList.add('flex');
  },

  closeEditClientModal(){ const m = document.getElementById('edit-client-modal'); if (m){ m.classList.add('hidden'); m.classList.remove('flex'); } this.editingClient = null; },


  // Nuova funzione per cambiare scheda
  setClientView(view) {
      const modal = document.getElementById('edit-client-modal');
      if (modal && !modal.classList.contains('hidden')) {
          // Add fade out transition
          const appElement = document.getElementById('app');
          if (appElement) {
              appElement.classList.add('transitioning');
              setTimeout(() => {
                  this.currentClientView = view;
                  this.openEditClientModal(this.editingClient, view);
                  setTimeout(() => {
                      appElement.classList.remove('transitioning');
                  }, 10);
              }, 300);
          } else {
              this.currentClientView = view;
              this.openEditClientModal(this.editingClient, view);
          }
      }
  },

  // Funzione per generare il contenuto dinamico del modale
  renderClientManagementContent(uid) {
    const clientData = this.clientsData[uid] || {};
    const clientState = clientData.data || {};
    
    // Funzioni helper fittizie per le dashboard
    const getTodayDateString = () => new Date().toISOString().slice(0, 10);
    
    // ----------- Allenamento Dashboard (Simplified) -----------
    const renderWorkoutDashboard = () => {
        const today = getTodayDateString();
        const complianceToday = clientState.dailyCompliance[today] || { workout:false };
        const isCompleted = complianceToday.workout;
        

        const workoutsByDay = (clientState.workout || []).reduce((acc, w) => {
            if (!acc[w.day]) acc[w.day] = [];
            acc[w.day].push(w);
            return acc;
        }, {});

        const workoutDaysHTML = Object.keys(workoutsByDay).sort().map(day => {
            const exercisesHTML = workoutsByDay[day].map((w, index) => {
                // Se questo esercizio è in modifica, mostra il form
                if (proApp.editingWorkoutId === w.id) {
                    return `<li class="py-2 border-b last:border-b-0 text-sm bg-blue-50 p-2 rounded-lg mt-2">
                        <form onsubmit="event.preventDefault(); proApp.updateClientWorkout('${uid}', ${w.id}, this.day.value, this.exercise.value, this.sets.value, this.reps.value, this.load.value);">
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <input type="text" name="day" value="${w.day}" placeholder="GIORNO" required class="w-full p-2 border rounded-lg text-xs">
                                <input type="text" name="exercise" value="${w.exercise}" placeholder="ESERCIZIO" required class="w-full p-2 border rounded-lg text-xs">
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <input type="number" name="sets" value="${w.sets}" placeholder="SERIE" class="w-full p-2 border rounded-lg text-xs">
                                <input type="number" name="reps" value="${w.reps}" placeholder="REP" class="w-full p-2 border rounded-lg text-xs">
                                <input type="text" name="load" value="${w.load}" placeholder="CARICO" class="w-full p-2 border rounded-lg text-xs">
                            </div>
                            <div class="flex justify-between mt-2">
                                <button type="submit" class="text-green-600 hover:text-green-800 font-semibold text-xs">SALVA</button>
                                <button type="button" onclick="proApp.cancelEditingWorkout()" class="text-gray-500 hover:text-gray-700 text-xs">ANNULLA</button>
                            </div>
                        </form>
                    </li>`;
                }
                // Altrimenti mostra la visualizzazione normale
                return `<li class="py-2 border-b last:border-b-0 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">${w.exercise?.toUpperCase() || 'N/D'}</span>
                        <div class="flex space-x-2">
                            <button onclick="proApp.startEditingWorkout(${w.id})" class="text-blue-500 hover:text-blue-700 transition">Modifica</button>
                            <button onclick="proApp.removeClientWorkout('${uid}', ${w.id})" class="text-red-500 hover:text-red-700 transition">Rimuovi</button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-600">GIORNO: ${w.day} | SERIE: ${w.sets} | REP: ${w.reps} | CARICO: ${w.load}</p>
                </li>`;
            }).join('');
            return `<div class="mb-4"><h4 class="text-xl font-bold text-indigo-600">${day}</h4><ul class="space-y-1">${exercisesHTML}</ul></div>`;
        }).join('');

        return `<div class="p-4 space-y-6">
            <h2 class="text-2xl font-bold text-indigo-600">PIANO DI ALLENAMENTO</h2>
            <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                <h3 class="text-xl font-bold mb-4">ESERCIZI (${(clientState.workout || []).length})</h3>
                <div class="space-y-4">${workoutDaysHTML || `<p class="text-gray-500 p-2">Nessun esercizio nel piano.</p>`}</div>
                <button onclick="proApp.clearClientData('${uid}', 'workout')" class="mt-4 p-2 w-full text-sm bg-red-100 text-red-700 font-semibold rounded-lg hover:bg-red-200">CANCELLA TUTTO</button>
            </div>
            <h3 class="text-xl font-bold mb-4">AGGIUNGI ESERCIZIO</h3>
            <form onsubmit="event.preventDefault(); proApp.addClientWorkout('${uid}', this.day.value, this.exercise.value, this.sets.value, this.reps.value, this.load.value); this.reset();" class="space-y-2 bg-white p-4 rounded-lg shadow">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" name="day" placeholder="GIORNO (ES. A, B)" required class="w-full p-3 border rounded-lg">
                    <input type="text" name="exercise" placeholder="NOME ESERCIZIO" required class="w-full p-3 border rounded-lg">
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <input type="number" name="sets" placeholder="SERIE" class="w-full p-3 border rounded-lg">
                    <input type="number" name="reps" placeholder="REP" class="w-full p-3 border rounded-lg">
                    <input type="text" name="load" placeholder="CARICO (KG/N/D)" class="w-full p-3 border rounded-lg">
                </div>
                <button type="submit" class="w-full p-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 mt-4">AGGIUNGI</button>
            </form>
            <div class="bg-white p-4 rounded-lg shadow mt-4">
              <h3 class="text-xl font-bold mb-4">CARICA PIANO / FILE</h3>
              <input type="file" onchange="proApp.uploadFile(event, '${uid}', 'workout')" accept=".pdf,.doc,.docx,.txt,.json" class="w-full p-3 border rounded-lg bg-white text-gray-700 text-sm">
              <button onclick="proApp.setClientView('workoutImport')" class="mt-2 p-3 w-full bg-blue-100 text-blue-700 font-bold rounded-lg hover:bg-blue-200">INCOLLA TESTO / IMPORTA</button>
            </div>
        </div>`;
    };
    
    // CORREZIONE QUI: Modificati i riferimenti a window.app con proApp e aggiunto l'UID
    const renderWorkoutImport = () => {
      const uid = proApp.editingClient;
      return `<div class="card"><h2 class="text-2xl font-bold mb-4 text-blue-600">IMPORTA PIANO ALLENAMENTO</h2><p class="mb-4 text-gray-700 no-uppercase">Incolla il tuo piano di allenamento qui. Sono supportati i formati semplici (es. riga per riga), CSV (Giorno, Esercizio, Serie, Reps, Carico) o JSON array.</p><textarea id="workout-import-area" class="w-full p-4 border rounded-lg h-64 font-mono text-sm no-uppercase" placeholder="INCOLLA QUI IL TESTO DEL TUO PIANO..."></textarea><button onclick="proApp.importWorkoutPlan('${uid}', document.getElementById('workout-import-area').value)" class="w-full p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 mt-4">IMPORTA PIANO</button><button onclick="proApp.setClientView('workout')" class="w-full p-3 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 mt-2">ANNULLA</button></div>`;
    };

    // ----------- Dieta Dashboard (Simplified) -----------
    const renderDietDashboard = () => {
        const today = getTodayDateString();
        const complianceToday = clientState.dailyCompliance[today] || { diet:false };
        const isCompleted = complianceToday.diet;
            

        const dayLabels = ['LUNEDÌ','MARTEDÌ','MERCOLEDÌ','GIOVEDÌ','VENERDÌ','SABATO','DOMENICA'];
        const dietPlanHTML = (clientState.dietPlan?.plan || []).sort((a, b) => dayLabels.indexOf(a.day) - dayLabels.indexOf(b.day)).map((dayPlan, dayIndex) => {
            const mealsHTML = dayPlan.meals.map((meal, mealIndex) => {
                // Se questo pasto è in modifica, mostra il form
                if (proApp.editingDietMeal && proApp.editingDietMeal.dayIndex === dayIndex && proApp.editingDietMeal.mealIndex === mealIndex) {
                    return `<li class="py-2 border-b last:border-b-0 text-sm bg-blue-50 p-2 rounded-lg mt-2">
                        <form onsubmit="event.preventDefault(); proApp.updateClientDietMeal('${uid}', ${dayIndex}, ${mealIndex}, this.category.value, this.description.value, this.weight.value, this.type.value, this.calories.value);">
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <input type="text" name="category" value="${meal.category}" placeholder="TIPOLOGIA (COLAZIONE)" required class="w-full p-2 border rounded-lg text-xs">
                                <input type="text" name="description" value="${meal.description}" placeholder="DESCRIZIONE (UOVA, PANE)" required class="w-full p-2 border rounded-lg text-xs">
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <input type="text" name="weight" value="${meal.weight}" placeholder="GRAMMATURA (150G)" required class="w-full p-2 border rounded-lg text-xs">
                                <input type="text" name="type" value="${meal.type}" placeholder="ALTRO (RICETTA)" required class="w-full p-2 border rounded-lg text-xs">
                                <input type="number" name="calories" value="${meal.calories}" placeholder="KCAL" required class="w-full p-2 border rounded-lg text-xs">
                            </div>
                            <div class="flex justify-between mt-2">
                                <button type="submit" class="text-green-600 hover:text-green-800 font-semibold text-xs">SALVA</button>
                                <button type="button" onclick="proApp.cancelEditingDietMeal()" class="text-gray-500 hover:text-gray-700 text-xs">ANNULLA</button>
                            </div>
                        </form>
                    </li>`;
                }
                // Altrimenti mostra la visualizzazione normale
                return `<li class="py-2 border-b last:border-b-0 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">${meal.category}: ${meal.description}</span>
                        <div class="flex space-x-2">
                            <button onclick="proApp.startEditingDietMeal(${dayIndex}, ${mealIndex})" class="text-blue-500 hover:text-blue-700 transition">Modifica</button>
                            <button onclick="proApp.removeClientDietMeal('${uid}', '${dayPlan.day}', ${mealIndex})" class="text-red-500 hover:text-red-700 transition">Rimuovi</button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-600">${meal.weight} (${meal.type}) | ${meal.calories} KCAL</p>
                </li>`;
            }).join('');
            const totalDayCalories = dayPlan.meals.reduce((sum, m) => sum + m.calories, 0);
            return `<div class="mb-4"><h4 class="text-xl font-bold text-indigo-600">${dayPlan.day} (${totalDayCalories} KCAL)</h4><ul class="space-y-1">${mealsHTML}</ul></div>`;
        }).join('');

        return `<div class="p-4 space-y-6">
            <h2 class="text-2xl font-bold text-indigo-600">PIANO DIETA (${clientState.dietPlan?.targetCalories || 0} KCAL OBIETTIVO)</h2>
            <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                <h3 class="text-xl font-bold mb-4">PIANO DIETA SETTIMANALE (${(clientState.dietPlan?.plan || []).length} giorni)</h3>
                <div class="space-y-4">${dietPlanHTML || `<p class="text-gray-500 p-2">Nessun piano dieta salvato.</p>`}</div>
                <button onclick="proApp.clearClientData('${uid}', 'dietPlan.plan')" class="mt-4 p-2 w-full text-sm bg-red-100 text-red-700 font-semibold rounded-lg hover:bg-red-200">CANCELLA PIANO</button>
            </div>
            <h3 class="text-xl font-bold mb-4">AGGIUNGI PASTO AL PIANO</h3>
            <form onsubmit="event.preventDefault(); proApp.addClientDietMeal('${uid}', this.day.value, this.category.value, this.description.value, this.weight.value, this.type.value, this.calories.value); this.reset();" class="space-y-2 bg-white p-4 rounded-lg shadow">
                <select name="day" required class="w-full p-3 border rounded-lg">
                    <option value="" disabled selected>SELEZIONA GIORNO</option><option value="LUNEDÌ">LUNEDÌ</option><option value="MARTEDÌ">MARTEDÌ</option><option value="MERCOLEDÌ">MERCOLEDÌ</option><option value="GIOVEDÌ">GIOVEDÌ</option><option value="VENERDÌ">VENERDÌ</option><option value="SABATO">SABATO</option><option value="DOMENICA">DOMENICA</option>
                </select>
                <input type="text" name="category" placeholder="TIPOLOGIA PASTO (ES. COLAZIONE)" required class="w-full p-3 border rounded-lg">
                <input type="text" name="description" placeholder="DESCRIZIONE CIBO (ES. UOVA, PANE)" required class="w-full p-3 border rounded-lg">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" name="weight" placeholder="GRAMMATURA (ES. 150G)" required class="w-full p-3 border rounded-lg">
                    <input type="text" name="type" placeholder="TIPOLOGIA (ES. RICETTA/INTEGRATORE)" required class="w-full p-3 border rounded-lg">
                </div>
                <input type="number" name="calories" placeholder="KCAL PASTO" required class="w-full p-3 border rounded-lg">
                <button type="submit" class="w-full p-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 mt-4">AGGIUNGI AL PIANO</button>
            </form>
            <div class="bg-white p-4 rounded-lg shadow mt-4">
              <h3 class="text-xl font-bold mb-4">CARICA PIANO / FILE</h3>
              <input type="file" onchange="proApp.uploadFile(event, '${uid}', 'diet')" accept=".pdf,.doc,.docx,.txt,.json" class="w-full p-3 border rounded-lg bg-white text-gray-700 text-sm">
              <button onclick="proApp.setClientView('dietImport')" class="mt-2 p-3 w-full bg-blue-100 text-blue-700 font-bold rounded-lg hover:bg-blue-200">INCOLLA TESTO / IMPORTA</button>
            </div>
        </div>`;
    };
     
    // CORREZIONE QUI: Modificati i riferimenti a window.app con proApp e aggiunto l'UID
    const renderDietImport = () => {
      const uid = proApp.editingClient;
      return `<div class="card"><h2 class="text-2xl font-bold mb-4 text-blue-600">IMPORTA PIANO DIETA</h2><p class="mb-4 text-gray-700 no-uppercase">Incolla il tuo piano di dieta qui in formato CSV: GIORNO, TIPOLOGIA, DESCRIZIONE, GRAMMATURA, ALTRO, KCAL (es. LUNEDÌ, PRANZO, POLLO, 150G, PETTO, 300).</p><textarea id="diet-import-area" class="w-full p-4 border rounded-lg h-64 font-mono text-sm no-uppercase" placeholder="INCOLLA QUI IL TESTO DEL TUO PIANO..."></textarea><button onclick="proApp.importDietPlan('${uid}', document.getElementById('diet-import-area').value)" class="w-full p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 mt-4">IMPORTA PIANO</button><button onclick="proApp.setClientView('diet')" class="w-full p-3 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 mt-2">ANNULLA</button></div>`;
    };

    // ----------- Misure Dashboard (Simplified) -----------
    const renderMeasurementsDashboard = () => {
        const logHTML = (clientState.measurementsLog || []).slice().reverse().map(log => {
            const raw = log.raw || {};
            const calc = log.calculated || {};
            return `<li class="py-3 border-b last:border-b-0 bg-white p-3 rounded-lg shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-bold text-indigo-600">${log.date}</span>
                    <button onclick="proApp.removeClientMeasurement('${uid}', ${log.id})" class="text-red-500 hover:text-red-700 transition">ELIMINA</button>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm text-gray-700">
                    <p><strong>PESO / ALTEZZA:</strong> ${raw.weight} KG / ${raw.height} CM</p>
                    <p><strong>BMI:</strong> ${calc.bmi} (${calc.classification})</p>
                    <p><strong>GRASSO:</strong> ${calc.bodyFat}%</p>
                    <p><strong>WHR:</strong> ${calc.whr} (${calc.risk})</p>
                    <p class="col-span-2"><strong>CIRCONFERENZE:</strong> VITA ${raw.waist}, FIANCHI ${raw.hips}, PETTO ${raw.chest}, BRACCIO ${raw.bicep}, COSCIA ${raw.thigh}</p>
                </div>
            </li>`;
        }).join('');

        return `<div class="p-4 space-y-6">
            <h2 class="text-2xl font-bold text-indigo-600">MISURE E PROGRESSI</h2>
            <h3 class="text-xl font-bold mb-4">SALVA NUOVA MISURA</h3>
            <form onsubmit="event.preventDefault(); proApp.addClientMeasurement('${uid}', this.weight.value, this.height.value, this.age.value, this.gender.value, this.waist.value, this.hips.value, this.chest.value, this.bicep.value, this.thigh.value); this.reset();" class="space-y-4 bg-white p-4 rounded-lg shadow">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" name="weight" placeholder="PESO (KG)" required step="0.1" class="w-full p-3 border rounded-lg">
                    <input type="number" name="height" placeholder="ALTEZZA (CM)" required class="w-full p-3 border rounded-lg">
                    <input type="number" name="age" placeholder="ETÀ" required class="w-full p-3 border rounded-lg">
                    <select name="gender" required class="w-full p-3 border rounded-lg"><option value="UOMO">UOMO</option><option value="DONNA">DONNA</option></select>
                </div>
                <h4 class="font-bold mt-4">CIRCONFERENZE (CM)</h4>
                <div class="grid grid-cols-3 gap-2">
                    <input type="number" name="waist" placeholder="VITA" required step="0.1" class="w-full p-3 border rounded-lg">
                    <input type="number" name="hips" placeholder="FIANCHI" required step="0.1" class="w-full p-3 border rounded-lg">
                    <input type="number" name="chest" placeholder="PETTO" required step="0.1" class="w-full p-3 border rounded-lg">
                    <input type="number" name="bicep" placeholder="BRACCIO" required step="0.1" class="w-full p-3 border rounded-lg">
                    <input type="number" name="thigh" placeholder="COSCIA" required step="0.1" class="w-full p-3 border rounded-lg">
                </div>
                <button type="submit" class="w-full p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 mt-4">REGISTRA MISURA</button>
            </form>
            <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                <h3 class="text-xl font-bold mb-4">CRONOLOGIA MISURE (${(clientState.measurementsLog || []).length})</h3>
                <ul class="space-y-3">${logHTML || `<p class="text-gray-500 p-2">Nessuna misurazione in cronologia.</p>`}</ul>
            </div>
        </div>`;
    };

    // ----------- Modifica Avanzata (JSON) -----------
    const renderAdvancedEdit = () => {
        return `<div class="p-4">
            <h3 class="text-xl font-bold mb-2 text-red-600">Modifica JSON Avanzata</h3>
            <p class="text-sm text-gray-500 mb-5">Modifica diretta della struttura dati JSON del cliente. Procedi con cautela. Clicca SALVA per aggiornare.</p>
            <form onsubmit="event.preventDefault(); proApp.saveClientEdits();">
                <textarea id="edit-json-area" class="w-full h-96 p-3 border rounded-lg font-mono text-sm resize-none">${JSON.stringify(clientData, null, 2)}</textarea>
                <div class="flex justify-end space-x-3 mt-4">
                    <button type="submit" class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700">Salva Modifiche JSON</button>
                </div>
            </form>
        </div>`;
    };

    switch(this.currentClientView) {
        case 'workout':
            return renderWorkoutDashboard();
        case 'workoutImport': 
          return renderWorkoutImport(); 
        case 'diet':
            return renderDietDashboard();
        case 'dietImport': 
          return  renderDietImport(); 
        case 'measurements':
            return renderMeasurementsDashboard();
        case 'advanced':
            return renderAdvancedEdit();
        default:
            return `<p class="p-4 text-center text-gray-500">Seleziona una scheda.</p>`;
    }
  },
  
  // Aggiornamento di openEditClientModal per gestire le schede
  openEditClientModal(uid, initialView = 'workout') {
    const clientData = this.clientsData[uid];
    if (!clientData) return alert("Dati del cliente non trovati.");
    this.editingClient = uid;
    this.currentClientView = initialView; // Imposta la vista corrente
    
    // Rirenderizza l'HTML del modale per aggiornare le classi 'active' dei pulsanti
    const modalContainer = document.getElementById('edit-client-modal');
    if (modalContainer) {
        // Un trucco per ri-renderizzare il modale e aggiornare i bottoni
        modalContainer.outerHTML = this.renderEditClientModal();
    }

    document.getElementById('edit-client-title').textContent = `Gestione Dati: ${clientData.displayUsername}`;
    document.getElementById('edit-client-content').innerHTML = this.renderClientManagementContent(uid);

    const modal = document.getElementById('edit-client-modal');
    modal.classList.remove('hidden'); modal.classList.add('flex');
  },
  
  closeEditClientModal(){ 
    const m = document.getElementById('edit-client-modal'); 
    if (m){ m.classList.add('hidden'); m.classList.remove('flex'); } 
    this.editingClient = null; 
    this.currentClientView = 'workout'; // Reset della vista
    this.editingWorkoutId = null; // Reset editing state
    this.editingDietMeal = null; // Reset editing state
  },

  async saveClientEdits() {
    if (this.currentClientView !== 'advanced' || !this.editingClient) return; // Salva solo dalla scheda JSON
    let updatedData;
    try { updatedData = JSON.parse(document.getElementById('edit-json-area').value); }
    catch (e) { return alert("Errore nel formato JSON: " + e.message); }

    const uid = this.editingClient;
    try {
      // Rimuovo l'uid che ho aggiunto per la comodità interna prima di salvare
      const { uid: _, ...dataToSave } = updatedData; 
      
      await apiCall('POST', { userId: uid, data: dataToSave });
      this.clientsData[uid] = updatedData;
      
      alert("Dati del cliente aggiornati con successo.");
      await this.loadClientsData();
      this.render(); // Ricarica la dashboard principale

      // Riapre il modale sulla stessa scheda
      this.openEditClientModal(uid, 'advanced');
    } catch (err) {
      console.error("Errore saveClientEdits:", err);
      alert("Errore durante il salvataggio: " + (err?.message || err));
    }
  },

  // ------------- NUOVE FUNZIONI CRUD PER IL PROFESSIONISTA -------------
  
  // Inizia la modifica di un esercizio (mostra il form inline)
  startEditingWorkout(exerciseId) {
      this.editingWorkoutId = exerciseId;
      this.openEditClientModal(this.editingClient, 'workout');
  },
  
  // Annulla la modifica di un esercizio
  cancelEditingWorkout() {
      this.editingWorkoutId = null;
      this.openEditClientModal(this.editingClient, 'workout');
  },
  
  // Aggiorna un esercizio esistente (simile a index.html)
  async updateClientWorkout(uid, exerciseId, day, exercise, sets, reps, load) {
      if (!uid) return;
      
      const clientData = this.clientsData[uid];
      if (!clientData || clientData.userType !== 'user') return alert("Cliente non valido.");
      
      const workout = clientData.data.workout || [];
      const workoutItem = workout.find(w => w.id === exerciseId);
      
      if (!workoutItem) return alert("Esercizio non trovato.");
      
      try {
          // Aggiorna l'esercizio
          workoutItem.day = String(day).toUpperCase();
          workoutItem.exercise = exercise;
          workoutItem.sets = parseInt(sets) || 0;
          workoutItem.reps = parseInt(reps) || 0;
          workoutItem.load = load ? load.trim().toUpperCase() : 'N/D';
          
          clientData.data.workout = workout;
          clientData.data.workoutUpdatedAt = new Date().toISOString();
          await apiCall('POST', { userId: uid, data: clientData });
          
          this.clientsData[uid].data.workout = workout;
          this.editingWorkoutId = null;
          this.openEditClientModal(uid, 'workout');
      } catch (err) {
          console.error("Errore updateClientWorkout:", err);
          alert("Errore durante la modifica dell'esercizio: " + (err?.message || err));
      }
  },
  
  // Inizia la modifica di un pasto (mostra il form inline)
  startEditingDietMeal(dayIndex, mealIndex) {
      this.editingDietMeal = { dayIndex, mealIndex };
      this.openEditClientModal(this.editingClient, 'diet');
  },
  
  // Annulla la modifica di un pasto
  cancelEditingDietMeal() {
      this.editingDietMeal = null;
      this.openEditClientModal(this.editingClient, 'diet');
  },
  
  // Aggiorna un pasto esistente (simile a index.html)
  async updateClientDietMeal(uid, dayIndex, mealIndex, category, description, weight, type, calories) {
      if (!uid) return;
      
      const clientData = this.clientsData[uid];
      if (!clientData || clientData.userType !== 'user') return alert("Cliente non valido.");
      
      const parsedCalories = parseInt(calories);
      if (isNaN(parsedCalories) || parsedCalories <= 0) return alert("LE KCAL DEVONO ESSERE UN NUMERO POSITIVO.");
      
      const dietPlan = clientData.data.dietPlan?.plan || [];
      const day = dietPlan[dayIndex];
      
      if (!day || !day.meals[mealIndex]) return alert("Pasto non trovato.");
      
      try {
          // Aggiorna il pasto
          const meal = day.meals[mealIndex];
          meal.category = category.toUpperCase();
          meal.description = description.toUpperCase();
          meal.weight = weight.toUpperCase();
          meal.type = type.toUpperCase();
          meal.calories = parsedCalories;
          
          clientData.data.dietPlan.plan = dietPlan;
          clientData.data.dietPlan.updatedAt = new Date().toISOString();
          await apiCall('POST', { userId: uid, data: clientData });
          
          this.clientsData[uid].data.dietPlan.plan = dietPlan;
          this.editingDietMeal = null;
          this.openEditClientModal(uid, 'diet');
      } catch (err) {
          console.error("Errore updateClientDietMeal:", err);
          alert("Errore durante la modifica del pasto: " + (err?.message || err));
      }
  },
  
  // Rimuovi esercizio esistente
  async removeClientWorkout(uid, exerciseId) {
      if (!confirm("Sei sicuro di voler rimuovere questo esercizio?")) return;
      if (!uid) return;
      
      const clientData = this.clientsData[uid];
      if (!clientData || clientData.userType !== 'user') return alert("Cliente non valido.");
      
      const newWorkout = (clientData.data.workout || []).filter(w => w.id !== exerciseId);
      
      try {
          clientData.data.workout = newWorkout;
          clientData.data.workoutUpdatedAt = new Date().toISOString();
          await apiCall('POST', { userId: uid, data: clientData });
          
          this.clientsData[uid].data.workout = newWorkout;
          this.openEditClientModal(uid, 'workout');
      } catch (err) {
          console.error("Errore removeClientWorkout:", err);
          alert("Errore durante la rimozione dell'esercizio: " + (err?.message || err));
      }
  },
  
  // Aggiunta di un Esercizio al Cliente
  async addClientWorkout(uid, day, exercise, sets, reps, load) {
      if (!uid) return;

      const clientData = this.clientsData[uid];
      if (!clientData || clientData.userType !== 'user') return alert("Cliente non valido.");
      
      const newWorkout = {
          id: Date.now() + Math.floor(Math.random()*10000),
          day: String(day).toUpperCase(),
          exercise: exercise,
          sets: parseInt(sets) || 0,
          reps: parseInt(reps) || 0,
          load: load ? load.trim().toUpperCase() : 'N/D'
      };

      const newWorkoutArray = [...(clientData.data.workout || []), newWorkout];

      try {
          clientData.data.workout = newWorkoutArray;
          clientData.data.workoutUpdatedAt = new Date().toISOString();
          await apiCall('POST', { userId: uid, data: clientData });
          
          this.clientsData[uid].data.workout = newWorkoutArray;
          this.openEditClientModal(uid, 'workout');
      } catch (err) {
          console.error("Errore addClientWorkout:", err);
          alert("Errore durante l'aggiunta dell'esercizio: " + (err?.message || err));
      }
  },

  
  // Rimuovi pasto esistente
  async removeClientDietMeal(uid, dayName, mealIndex) {
      if (!confirm("Sei sicuro di voler rimuovere questo pasto?")) return;
      if (!uid) return;
      
      const clientData = this.clientsData[uid];
      if (!clientData || clientData.userType !== 'user') return alert("Cliente non valido.");
      
      const dietPlan = clientData.data.dietPlan?.plan || [];
      const dayPlan = dietPlan.find(p => p.day === dayName);
      
      if (!dayPlan) return alert("Giorno non trovato.");
      
      try {
          // Rimuovi il pasto
          dayPlan.meals.splice(mealIndex, 1);
          
          // Se il giorno non ha più pasti, rimuovi il giorno
          if (dayPlan.meals.length === 0) {
              const dayIndex = dietPlan.findIndex(p => p.day === dayName);
              dietPlan.splice(dayIndex, 1);
          }
          
          clientData.data.dietPlan.plan = dietPlan;
          clientData.data.dietPlan.updatedAt = new Date().toISOString();
          await apiCall('POST', { userId: uid, data: clientData });
          
          this.clientsData[uid].data.dietPlan.plan = dietPlan;
          this.openEditClientModal(uid, 'diet');
      } catch (err) {
          console.error("Errore removeClientDietMeal:", err);
          alert("Errore durante la rimozione del pasto: " + (err?.message || err));
      }
  },
  
  async addClientDietMeal(uid, day, category, description, weight, type, calories) {
      if (!uid) return;

      const clientData = this.clientsData[uid];
      if (!clientData || clientData.userType !== 'user') return alert("Cliente non valido.");
      
      const newMeal = { 
          category: category.toUpperCase(), 
          description: description.toUpperCase(), 
          weight: weight.toUpperCase(), 
          type: type.toUpperCase(), 
          calories: Number(calories) 
      };
      
      const dietPlan = clientData.data.dietPlan?.plan || [];
      const dayIndex = dietPlan.findIndex(p => p.day === String(day).toUpperCase());
      
      let newDietPlan;

      if (dayIndex !== -1) {
          newDietPlan = [...dietPlan];
          newDietPlan[dayIndex].meals.push(newMeal);
      } else {
          newDietPlan = [...dietPlan, { day: String(day).toUpperCase(), meals: [newMeal] }];
      }
      
      try {
          clientData.data.dietPlan.plan = newDietPlan;
          clientData.data.dietPlan.updatedAt = new Date().toISOString();
          await apiCall('POST', { userId: uid, data: clientData });
          
          this.clientsData[uid].data.dietPlan.plan = newDietPlan;
          this.openEditClientModal(uid, 'diet');
      } catch (err) {
          console.error("Errore addClientDietMeal:", err);
          alert("Errore durante l'aggiunta del pasto: " + (err?.message || err));
      }
  },
  
  async clearClientData(uid, fieldPath) {
      if (!confirm(`Sei sicuro di voler cancellare i dati in ${fieldPath}? Questa azione è irreversibile.`)) return;
      if (!uid) return;
      
      try {
          const result = await apiCall('GET', { userId: uid });
          if (!result.success || !result.data) return alert("Documento cliente non trovato.");

          let clientData = result.data;
          let data = clientData.data;

          if (fieldPath === 'workout') {
              data.workout = [];
          } else if (fieldPath === 'dietPlan.plan') {
              data.dietPlan.plan = [];
          } else {
              return alert("Path non supportato per la cancellazione rapida.");
          }
          
          clientData.data = data;
          await apiCall('POST', { userId: uid, data: clientData });
          
          this.clientsData[uid].data = data;
          this.openEditClientModal(uid, fieldPath.includes('diet') ? 'diet' : 'workout');
          alert("Dati cancellati con successo!");

      } catch (err) {
          console.error("Errore clearClientData:", err);
          alert("Errore durante la cancellazione dei dati: " + (err?.message || err));
      }
  },

  async removeClientMeasurement(uid, measurementId) {
      if (!confirm("Sei sicuro di voler eliminare questa misurazione?")) return;
      if (!uid) return;

      const clientData = this.clientsData[uid];
      if (!clientData) return alert("Cliente non valido.");
      
      const newLog = (clientData.data.measurementsLog || []).filter(log => log.id !== measurementId);

      try {
          clientData.data.measurementsLog = newLog;
          await apiCall('POST', { userId: uid, data: clientData });
          
          this.clientsData[uid].data.measurementsLog = newLog;
          this.openEditClientModal(uid, 'measurements');
          alert("Misurazione rimossa con successo!");
      } catch (err) {
          console.error("Errore removeClientMeasurement:", err);
          alert("Errore durante la rimozione della misurazione: " + (err?.message || err));
      }
  },

  async addClientMeasurement(uid, weight, height, age, gender, waist, hips, chest, bicep, thigh) {
      if (!uid) return;
      
      const today = new Date().toISOString().slice(0, 10);
      const rawData = {
          weight: Number(weight),
          height: Number(height),
          age: Number(age),
          gender: String(gender),
          waist: Number(waist),
          hips: Number(hips),
          chest: Number(chest),
          bicep: Number(bicep),
          thigh: Number(thigh),
      };
      
      const calculateBMI = (w, h) => (w / ((h / 100) ** 2)).toFixed(2);
      const calculateWHR = (w, h) => (w / h).toFixed(2);
      
      const calculatedData = {
          bmi: calculateBMI(rawData.weight, rawData.height),
          whr: calculateWHR(rawData.waist, rawData.hips),
          bodyFat: 'N/D',
          classification: 'Da Calcolare',
          risk: 'Da Calcolare',
      };

      const newMeasurement = {
          id: Date.now(),
          date: today,
          raw: rawData,
          calculated: calculatedData,
      };

      const clientData = this.clientsData[uid];
      const newLog = [...(clientData.data.measurementsLog || []), newMeasurement];

      try {
          clientData.data.measurementsLog = newLog;
          await apiCall('POST', { userId: uid, data: clientData });
          
          this.clientsData[uid].data.measurementsLog = newLog;
          this.openEditClientModal(uid, 'measurements');
          alert("Misurazione aggiunta con successo!");
      } catch (err) {
          console.error("Errore addClientMeasurement:", err);
          alert("Errore durante l'aggiunta della misurazione: " + (err?.message || err));
      }
  },
  
  async saveWorkoutCompliance(uid, status) {
      if (!uid) return;
      const today = new Date().toISOString().slice(0, 10);
      
      try {
          const clientData = this.clientsData[uid];
          clientData.data.dailyCompliance[today] = clientData.data.dailyCompliance[today] || {};
          clientData.data.dailyCompliance[today].workout = status;
          
          await apiCall('POST', { userId: uid, data: clientData });
          this.clientsData[uid].data.dailyCompliance[today].workout = status;

          this.openEditClientModal(uid, 'workout');
          alert("Stato di completamento Allenamento aggiornato.");
      } catch (err) {
          console.error("Errore saveWorkoutCompliance:", err);
          alert("Errore aggiornamento stato: " + (err?.message || err));
      }
  },

  async saveDietCompliance(uid, status) {
      if (!uid) return;
      const today = new Date().toISOString().slice(0, 10);
      
      try {
          const clientData = this.clientsData[uid];
          clientData.data.dailyCompliance[today] = clientData.data.dailyCompliance[today] || {};
          clientData.data.dailyCompliance[today].diet = status;
          
          await apiCall('POST', { userId: uid, data: clientData });
          this.clientsData[uid].data.dailyCompliance[today].diet = status;

          this.openEditClientModal(uid, 'diet');
          alert("Stato di completamento Dieta aggiornato.");
      } catch (err) {
          console.error("Errore saveDietCompliance:", err);
          alert("Errore aggiornamento stato: " + (err?.message || err));
      }
  },
  
  // FUNZIONI DI IMPORTAZIONE (PLACEHOLDER)
  async importWorkoutPlan(uid, rawText) {
      if (!uid) return;
      console.log(`Tentativo di importazione Allenamento per ${uid}`, rawText);
      
      showSpinner();
      try {
        const clientData = this.clientsData[uid];
        if (!clientData) {
          alert(`Cliente ${uid} non trovato.`);
          return;
        }
        
        // Use Gemini to standardize the workout plan
        const standardizedData = await standardizeWorkoutWithGemini(rawText);
        
        if (standardizedData && Array.isArray(standardizedData) && standardizedData.length > 0) {
          // Convert to internal format
          const workoutData = standardizedData.map(item => ({
            id: Date.now() + Math.random(),
            day: item.day?.toUpperCase() || 'NON SPECIFICATO',
            exercise: item.exercise?.toUpperCase() || 'NON SPECIFICATO',
            sets: parseInt(item.sets) || 0,
            reps: parseInt(item.reps) || 0,
            load: item.load ? item.load.toString().toUpperCase() : 'N/D'
          }));
          
          // Update client data
          clientData.data.workout = workoutData;
          await apiCall('POST', { userId: uid, data: clientData });
          
          // Refresh data
          this.clientsData[uid].data.workout = workoutData;
          alert(`Piano allenamento importato e standardizzato con successo (${workoutData.length} esercizi).`);
        } else {
          alert('Nessun dato valido trovato nel testo.');
        }
      } catch (error) {
        console.error('Error importing workout plan:', error);
        alert('Errore durante l\'importazione: ' + error.message);
      } finally {
        hideSpinner();
      }
      
      this.openEditClientModal(uid, 'workout');
  },

  async importDietPlan(uid, rawText) {
      if (!uid) return;
      console.log(`Tentativo di importazione Dieta per ${uid}`, rawText);
      
      showSpinner();
      try {
        const clientData = this.clientsData[uid];
        if (!clientData) {
          alert(`Cliente ${uid} non trovato.`);
          return;
        }
        
        // Use Gemini to standardize the diet plan
        const standardizedData = await standardizeDietWithGemini(rawText);
        
        if (standardizedData && Array.isArray(standardizedData) && standardizedData.length > 0) {
          // Update client data
          if (!clientData.data.dietPlan) {
            clientData.data.dietPlan = { targetCalories: 2000, plan: [] };
          }
          clientData.data.dietPlan.plan = standardizedData;
          await apiCall('POST', { userId: uid, data: clientData });
          
          // Refresh data
          this.clientsData[uid].data.dietPlan.plan = standardizedData;
          alert(`Piano dieta importato e standardizzato con successo (${standardizedData.length} giorni).`);
        } else {
          alert('Nessun dato valido trovato nel testo.');
        }
      } catch (error) {
        console.error('Error importing diet plan:', error);
        alert('Errore durante l\'importazione: ' + error.message);
      } finally {
        hideSpinner();
      }
      
      this.openEditClientModal(uid, 'diet');
  },
  
  async uploadFile(event, uid, type) {
      const file = event.target.files[0];
      if (!file) return;
      
      console.log(`Caricamento file ${file.name} per ${uid} (${type})`);
      
      showSpinner();
      try {
        const clientData = this.clientsData[uid];
        if (!clientData) {
          alert(`Cliente ${uid} non trovato.`);
          return;
        }
        
        // Read file content
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            let textContent = '';
            if (file.type === 'text/plain' || file.type === 'text/csv' || file.name.endsWith('.txt') || file.name.endsWith('.csv')) {
              textContent = e.target.result;
            } else if (file.type === 'application/json' || file.name.endsWith('.json')) {
              textContent = e.target.result;
            } else {
              // For other file types, try to extract text from base64
              const base64Data = e.target.result.split(',')[1];
              const binaryString = atob(base64Data);
              textContent = binaryString;
            }
            
            if (type === 'workout') {
              // Use Gemini to standardize the workout plan
              const standardizedData = await standardizeWorkoutWithGemini(textContent);
              
              if (standardizedData && Array.isArray(standardizedData) && standardizedData.length > 0) {
                const workoutData = standardizedData.map(item => ({
                  id: Date.now() + Math.random(),
                  day: item.day?.toUpperCase() || 'NON SPECIFICATO',
                  exercise: item.exercise?.toUpperCase() || 'NON SPECIFICATO',
                  sets: parseInt(item.sets) || 0,
                  reps: parseInt(item.reps) || 0,
                  load: item.load ? item.load.toString().toUpperCase() : 'N/D'
                }));
                
                clientData.data.workout = workoutData;
                await apiCall('POST', { userId: uid, data: clientData });
                this.clientsData[uid].data.workout = workoutData;
                alert(`File ${file.name} caricato e standardizzato (${workoutData.length} esercizi).`);
              }
            } else if (type === 'diet') {
              // Use Gemini to standardize the diet plan
              const standardizedData = await standardizeDietWithGemini(textContent);
              
              if (standardizedData && Array.isArray(standardizedData) && standardizedData.length > 0) {
                if (!clientData.data.dietPlan) {
                  clientData.data.dietPlan = { targetCalories: 2000, plan: [] };
                }
                clientData.data.dietPlan.plan = standardizedData;
                await apiCall('POST', { userId: uid, data: clientData });
                this.clientsData[uid].data.dietPlan.plan = standardizedData;
                alert(`File ${file.name} caricato e standardizzato (${standardizedData.length} giorni).`);
              }
            }
            
            this.openEditClientModal(uid, type);
          } catch (error) {
            console.error('Error processing file:', error);
            alert('Errore durante l\'elaborazione del file: ' + error.message);
          } finally {
            hideSpinner();
          }
        };
        
        // Read as text for text-based files, otherwise as data URL
        if (file.type === 'text/plain' || file.type === 'text/csv' || file.name.endsWith('.txt') || file.name.endsWith('.csv') || file.name.endsWith('.json')) {
          reader.readAsText(file);
        } else {
          reader.readAsDataURL(file);
        }
        
        event.target.value = '';
      } catch (error) {
        console.error('Error uploading file:', error);
        alert('Errore durante il caricamento del file: ' + error.message);
        hideSpinner();
      }
  },
  // FINE NUOVE FUNZIONI CRUD
  
  // ============================================
  // MIGRATION FUNCTIONS
  // ============================================
  
  handleDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    const dropZone = document.getElementById('drop-zone');
    if (dropZone) dropZone.classList.add('dragover');
  },
  
  handleDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    const dropZone = document.getElementById('drop-zone');
    if (dropZone) dropZone.classList.remove('dragover');
  },
  
  handleDrop(event) {
    event.preventDefault();
    event.stopPropagation();
    const dropZone = document.getElementById('drop-zone');
    if (dropZone) dropZone.classList.remove('dragover');
    
    const files = Array.from(event.dataTransfer.files);
    this.addFiles(files);
  },
  
  handleFileSelect(event) {
    const files = Array.from(event.target.files);
    this.addFiles(files);
    event.target.value = '';
  },
  
  addFiles(files) {
    const allowedExtensions = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'txt'];
    const validFiles = files.filter(file => {
      const extension = file.name.split('.').pop().toLowerCase();
      return allowedExtensions.includes(extension);
    });
    
    if (validFiles.length !== files.length) {
      alert(`Alcuni file sono stati ignorati. Sono consentiti solo: ${allowedExtensions.join(', ')}`);
    }
    
    this.migrationFiles = [...this.migrationFiles, ...validFiles];
    this.render();
  },
  
  removeFile(index) {
    this.migrationFiles.splice(index, 1);
    this.render();
  },
  
  clearFiles() {
    this.migrationFiles = [];
    this.render();
  },
  
  clearMigrationResults() {
    this.migrationResults = [];
    this.render();
  },
  
  async startMigration() {
    if (this.migrationFiles.length === 0) {
      alert('Seleziona almeno un file per la migrazione.');
      return;
    }
    
    showSpinner();
    this.migrationResults = [];
    
    for (const file of this.migrationFiles) {
      try {
        const result = await this.migrateUserFromFile(file);
        this.migrationResults.push(result);
      } catch (error) {
        console.error(`Error migrating file ${file.name}:`, error);
        this.migrationResults.push({
          filename: file.name,
          success: false,
          message: `Errore: ${error.message}`
        });
      }
    }
    
    hideSpinner();
    this.migrationFiles = [];
    await this.loadClientsData();
    this.render();
  },

    async  async migrateUserFromFile(file) {
        try {
            const acceptedFormats = {
                '.pdf': 'pdf',
                '.docx': 'office',
                '.xlsx': 'office',
                '.txt': 'txt'
            };

            const fileName = file.name;
            const lastDotIndex = fileName.lastIndexOf('.');
            if (lastDotIndex === -1) throw new Error('Il file non ha estensione.');

            const fileExtension = fileName.substring(lastDotIndex).toLowerCase();
            const parserType = acceptedFormats[fileExtension];
            if (!parserType) throw new Error(`Formato ${fileExtension} non supportato.`);

            let textContent = '';

            if (parserType === 'txt') {
                textContent = await readFileAsText(file);
            } else if (parserType === 'pdf') {
                textContent = await extractTextFromPdf(file);
            } else if (parserType === 'office') {
                textContent = await extractTextFromOffice(file);
            }

            // Qui puoi fare l'elaborazione del testo (es: invio a Gemini)
            console.log("✅ Testo estratto:", textContent.substring(0, 300), "...");

            // Puoi proseguire qui con la tua logica (estrazione userData ecc.)
            return textContent;

        } catch (error) {
            console.error("Errore durante la migrazione:", error);
            alert(`Errore: ${error.message}`);
        }
    },

// 🔹 Lettura file come testo
    async  readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = e => reject(e);
            reader.readAsText(file);
        });
    },

// 🔹 Lettura file come ArrayBuffer
    async  readFileAsArrayBuffer(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = e => reject(e);
            reader.readAsArrayBuffer(file);
        });
    },

// 🔹 Estrazione testo da PDF (usa pdf.js via CDN)
    async extractTextFromPdf(file) {
        const arrayBuffer = await readFileAsArrayBuffer(file);
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            fullText += textContent.items.map(item => item.str).join(' ') + '\n';
        }
        return fullText.trim();
    },

// 🔹 Estrazione testo da DOCX / XLSX (usa JSZip via CDN)
    async  extractTextFromOffice(file) {
        const arrayBuffer = await readFileAsArrayBuffer(file);
        const zip = await JSZip.loadAsync(arrayBuffer);
        const ext = file.name.split('.').pop().toLowerCase();

        if (ext === 'docx') {
            const docXml = await zip.file("word/document.xml").async("string");
            const text = docXml.replace(/<[^>]+>/g, ' ');
            return text;
        }

        if (ext === 'xlsx') {
            const sheets = Object.keys(zip.files).filter(f => f.match(/xl\/worksheets\/sheet\d+\.xml/));
            let allText = '';
            for (const sheet of sheets) {
                const xml = await zip.file(sheet).async("string");
                allText += xml.replace(/<[^>]+>/g, ' ') + '\n';
            }
            return allText.trim();
        }

        throw new Error(`Formato ${ext} non gestito in extractTextFromOffice`);
    },

  async extractUserDataWithGemini(textContent, filename) {
    try {
      const prompt = `You are a helpful assistant that extracts user data from files for migration purposes.

Extract the following information from the text and return it as a JSON object.

**IMPORTANT RULE ON DATA INTERPRETATION:** The data for measurements, workout, and diet plan may not always be written in a consistent, standard format. **Do not look for specific, fixed strings or keywords.** Instead, **intelligently infer** the nature and value of the data based on context and common-sense interpretation of terms (e.g., "peso," "altezza," "squat," "colazione," "prot" could mean "weight," "height," "squat," "breakfast," "protein" respectively).

- username: string (the person's name, e.g., "MARIO_ROSSI". If not found, use "USER" followed by a random number)
- measurements: object with fields (if available):
  - id: number (use current timestamp)
  - date: string (ISO date, use today's date)
  - raw: object with:
    - weight: number (in kg)
    - height: number (in cm)
    - age: number
    - gender: string ("UOMO" or "DONNA")
    - waist: number (in cm)
    - hips: number (in cm)
    - chest: number (in cm)
    - bicep: number (in cm)
    - thigh: number (in cm)
  - calculated: object with:
    - bmi: string (calculated BMI)
    - whr: string (waist-to-hip ratio)
    - bodyFat: string (body fat percentage or "N/D")
    - classification: string (BMI classification or "Da Calcolare")
    - risk: string (health risk or "Da Calcolare")
- workout: array of workout objects (if available), each with:
  - id: number (unique ID)
  - day: string (e.g., "GIORNO A", "LUNEDÌ")
  - exercise: string (exercise name in UPPERCASE)
  - sets: number (number of sets, default 0)
  - reps: number (number of reps, default 0)
  - load: string (weight/load, default "N/D")
- dietPlan: object (if available) with:
  - targetCalories: number (default 2000)
  - plan: array of day objects, each with:
    - day: string (e.g., "LUNEDÌ", "MARTEDÌ", etc.)
    - meals: array of meal objects, each with:
      - category: string (meal type, e.g., "COLAZIONE", "PRANZO", "CENA")
      - description: string (food description in UPPERCASE)
      - weight: string (portion size, e.g., "150G")
      - type: string (food type, e.g., "RICETTA", "INTEGRATORE")
      - calories: number

Important rules:
1. All text values must be in UPPERCASE
2. If data is not found, omit that field from the JSON (don't include null or empty values)
3. Return **ONLY** the JSON object, no other text
4. If you cannot extract any meaningful data, return: {"username": "USER_${Date.now()}"}

Here is the content from file "${filename}":
${textContent.substring(0, 15000)}`;

      const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          contents: [
            {
              parts: [
                {
                  text: prompt
                }
              ]
            }
          ]
        })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        const errorMessage = errorData.error || `Gemini API error: ${response.status}`;
        throw new Error(errorMessage);
      }

      const data = await response.json();
      const content = data.candidates[0].content.parts[0].text;
      
      // Extract JSON from response (might be wrapped in markdown code blocks)
      let jsonText = content;
      if (content.includes('```json')) {
        const match = content.match(/```json\n([\s\S]*?)\n```/);
        jsonText = match ? match[1] : content;
      } else if (content.includes('```')) {
        const match = content.match(/```\n([\s\S]*?)\n```/);
        jsonText = match ? match[1] : content;
      }
      
      const userData = JSON.parse(jsonText);
      
      // Ensure username exists
      if (!userData.username) {
        userData.username = `USER_${Date.now()}`;
      }
      
      return userData;
    } catch (error) {
      console.error('Error extracting user data with Gemini:', error);
      throw new Error('Impossibile estrarre i dati con Gemini: ' + error.message);
    }
  },
  
  async generateUniqueUsername(baseUsername) {
    const normalizedBase = baseUsername.replace(/\s+/g, '_').toUpperCase();
    let username = normalizedBase;
    let underscoreCount = 0;
    
    // Check if username exists
    while (underscoreCount <= 4) {
      const exists = await this.checkUsernameExists(username);
      if (!exists) {
        return username;
      }
      
      if (underscoreCount >= 4) {
        return null; // Max underscores reached
      }
      
      underscoreCount++;
      username = normalizedBase + '_'.repeat(underscoreCount);
    }
    
    return null;
  },
  
  async checkUsernameExists(username) {
    const userKey = username.toLowerCase();
    const hashBasedUid = simpleHash(userKey).toString();
    
    // Check in data.json
    try {
      const result = await apiCall('GET', { userId: hashBasedUid });
      if (result.success && result.data) {
        return true;
      }
    } catch (err) {
      console.error("Failed to check username:", err);
    }
    
    // Check in current clients list
    const clients = this.data.clients || [];
    const existsInClients = clients.some(c => c.username.toLowerCase() === userKey);
    
    return existsInClients;
  },
  // END MIGRATION FUNCTIONS
  
  async signOut() {
    try {
      localStorage.removeItem('currentUser');
    } catch (e) { console.warn("Errore durante signOut:", e); }
    window.location.href = "index.html";
  }
};

window.proApp = proApp;
document.addEventListener('DOMContentLoaded', () => proApp.init());
</script>
</body>
</html>