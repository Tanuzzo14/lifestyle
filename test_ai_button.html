<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test AI Button Feature</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        h1 { color: #333; }
        h2 { color: #666; }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>AI Button Feature Test Suite</h1>
    <div id="test-results"></div>

    <script type="module">
        const results = [];

        function addTest(name, passed, message) {
            results.push({ name, passed, message });
        }

        function displayResults() {
            const container = document.getElementById('test-results');
            let html = '';
            
            results.forEach(test => {
                html += `
                    <div class="test-section">
                        <h2>${test.name}</h2>
                        <div class="test-result ${test.passed ? 'pass' : 'fail'}">
                            <strong>${test.passed ? '✓ PASS' : '✗ FAIL'}</strong>
                            <p>${test.message}</p>
                        </div>
                    </div>
                `;
            });

            const passed = results.filter(r => r.passed).length;
            const total = results.length;
            
            html = `
                <div class="test-section">
                    <h2>Summary</h2>
                    <p><strong>${passed}/${total} tests passed</strong></p>
                </div>
            ` + html;

            container.innerHTML = html;
        }

        // Test 1: isBaseUserClient function logic
        function testIsBaseUserClient() {
            // Simulate the hash function from the code
            function simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                return hash;
            }

            const baseUserKey = "base_user";
            const expectedBaseUserUid = simpleHash(baseUserKey).toString();
            
            addTest(
                "Test 1: BASE_USER UID Calculation",
                expectedBaseUserUid === "2478585977",
                `BASE_USER UID should be "2478585977", got "${expectedBaseUserUid}"`
            );
        }

        // Test 2: Check measurement validation logic
        function testHasAllMeasurements() {
            const required = ['weight', 'height', 'age', 'gender', 'waist', 'hips', 'chest', 'bicep', 'thigh'];
            
            const fullMeasurement = {
                raw: {
                    weight: 75,
                    height: 175,
                    age: 30,
                    gender: 'UOMO',
                    waist: 80,
                    hips: 95,
                    chest: 100,
                    bicep: 35,
                    thigh: 55
                }
            };

            const incompleteMeasurement = {
                raw: {
                    weight: 75,
                    height: 175
                }
            };

            const hasAllFieldsFull = required.every(field => fullMeasurement.raw && fullMeasurement.raw[field]);
            const hasAllFieldsIncomplete = required.every(field => incompleteMeasurement.raw && incompleteMeasurement.raw[field]);

            addTest(
                "Test 2a: All Measurements Present",
                hasAllFieldsFull === true,
                `Should return true when all measurements are present`
            );

            addTest(
                "Test 2b: Missing Measurements",
                hasAllFieldsIncomplete === false,
                `Should return false when measurements are missing`
            );
        }

        // Test 3: Verify button visibility logic
        function testButtonVisibility() {
            const baseUserUid = "2478585977";
            
            // Simulate state with BASE_USER
            const stateWithBaseUser = {
                createdBy: baseUserUid
            };

            // Simulate state without BASE_USER
            const stateWithoutBaseUser = {
                createdBy: null
            };

            // Simulate state with different trainer
            const stateWithDifferentTrainer = {
                createdBy: "123456789"
            };

            const isBaseClient1 = stateWithBaseUser.createdBy === baseUserUid;
            const isBaseClient2 = stateWithoutBaseUser.createdBy === baseUserUid;
            const isBaseClient3 = stateWithDifferentTrainer.createdBy === baseUserUid;

            addTest(
                "Test 3a: User created by BASE_USER",
                isBaseClient1 === true,
                `Button should be visible for BASE_USER clients`
            );

            addTest(
                "Test 3b: User without createdBy",
                isBaseClient2 === false,
                `Button should NOT be visible for users without createdBy`
            );

            addTest(
                "Test 3c: User created by different trainer",
                isBaseClient3 === false,
                `Button should NOT be visible for users with different trainer`
            );
        }

        // Test 4: Verify Gemini prompts contain required elements
        function testGeminiPrompts() {
            const workoutPromptKeywords = ['mantenimento', 'tonificazione', 'muscolare'];
            const dietPromptKeywords = ['mediterraneo', 'mantenimento', 'tonificazione'];

            addTest(
                "Test 4a: Workout Prompt Keywords",
                workoutPromptKeywords.length === 3,
                `Workout prompt should include: ${workoutPromptKeywords.join(', ')}`
            );

            addTest(
                "Test 4b: Diet Prompt Keywords",
                dietPromptKeywords.length === 3,
                `Diet prompt should include: ${dietPromptKeywords.join(', ')} and MEDITERRANEO type`
            );
        }

        // Run all tests
        testIsBaseUserClient();
        testHasAllMeasurements();
        testButtonVisibility();
        testGeminiPrompts();

        // Display results
        displayResults();
    </script>
</body>
</html>
