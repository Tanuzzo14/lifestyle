<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test BASE_USER Creation</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .success {
      color: green;
      font-weight: bold;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background-color: #45a049;
    }
    pre {
      background-color: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Test BASE_USER Trainer Creation</h1>
  
  <div class="test-section">
    <h2>Test 1: Register Base User</h2>
    <p>This test registers a new base user and checks if BASE_USER trainer is created.</p>
    <button onclick="testRegisterBaseUser()">Run Test</button>
    <div id="test1-result"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Check BASE_USER Exists</h2>
    <p>This test verifies that BASE_USER trainer exists after registering a base user.</p>
    <button onclick="testBaseUserExists()">Run Test</button>
    <div id="test2-result"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: Verify User in BASE_USER Clients</h2>
    <p>This test checks if the registered base user is in BASE_USER's clients list.</p>
    <button onclick="testUserInBaseUserClients()">Run Test</button>
    <div id="test3-result"></div>
  </div>

  <div class="test-section">
    <h2>Test 4: Register Second Base User</h2>
    <p>This test registers another base user and verifies BASE_USER is reused (not recreated).</p>
    <button onclick="testRegisterSecondBaseUser()">Run Test</button>
    <div id="test4-result"></div>
  </div>

  <div class="test-section">
    <h2>Test 5: Clean Up Test Data</h2>
    <p>Remove test users and BASE_USER from data.json</p>
    <button onclick="cleanupTestData()">Clean Up</button>
    <div id="cleanup-result"></div>
  </div>

  <script type="module">
    import { Auth } from './auth.js';

    const API_URL = 'api.php';
    
    async function apiCall(method, params = {}) {
      try {
        const options = {
          method: method,
          headers: { 'Content-Type': 'application/json' }
        };
        
        if (method === 'GET') {
          const query = new URLSearchParams(params).toString();
          const response = await fetch(`${API_URL}?${query}`, options);
          const result = await response.json();
          return result;
        } else {
          options.body = JSON.stringify(params);
          const response = await fetch(API_URL, options);
          const result = await response.json();
          return result;
        }
      } catch (error) {
        console.error('Errore API:', error);
        return { success: false, error: error.message };
      }
    }

    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      return hash;
    }

    let testUser1Uid = null;
    let testUser2Uid = null;

    window.testRegisterBaseUser = async function() {
      const resultDiv = document.getElementById('test1-result');
      resultDiv.innerHTML = '<p>Testing...</p>';
      
      try {
        const testUsername = 'testuser' + Date.now();
        const testPassword = 'testpass123';
        
        const result = await Auth.register(testUsername, testPassword, 'user', (msg) => {
          console.log('Register message:', msg);
        });
        
        if (result) {
          testUser1Uid = result.uid;
          resultDiv.innerHTML = `
            <p class="success">✓ Test passed!</p>
            <pre>User registered: ${JSON.stringify(result, null, 2)}</pre>
          `;
        } else {
          resultDiv.innerHTML = '<p class="error">✗ Test failed: Registration returned null</p>';
        }
      } catch (error) {
        resultDiv.innerHTML = `<p class="error">✗ Test failed: ${error.message}</p>`;
      }
    };

    window.testBaseUserExists = async function() {
      const resultDiv = document.getElementById('test2-result');
      resultDiv.innerHTML = '<p>Testing...</p>';
      
      try {
        const baseUserUid = simpleHash('base_user').toString();
        const result = await apiCall('GET', { userId: baseUserUid });
        
        if (result.success && result.data) {
          const baseUserData = result.data;
          resultDiv.innerHTML = `
            <p class="success">✓ Test passed! BASE_USER exists</p>
            <pre>BASE_USER data: ${JSON.stringify(baseUserData, null, 2)}</pre>
          `;
        } else {
          resultDiv.innerHTML = '<p class="error">✗ Test failed: BASE_USER not found</p>';
        }
      } catch (error) {
        resultDiv.innerHTML = `<p class="error">✗ Test failed: ${error.message}</p>`;
      }
    };

    window.testUserInBaseUserClients = async function() {
      const resultDiv = document.getElementById('test3-result');
      resultDiv.innerHTML = '<p>Testing...</p>';
      
      try {
        if (!testUser1Uid) {
          resultDiv.innerHTML = '<p class="error">✗ Please run Test 1 first</p>';
          return;
        }

        const baseUserUid = simpleHash('base_user').toString();
        const result = await apiCall('GET', { userId: baseUserUid });
        
        if (result.success && result.data) {
          const baseUserData = result.data;
          const clients = baseUserData.clients || [];
          const userInClients = clients.find(c => c.uid === testUser1Uid);
          
          if (userInClients) {
            resultDiv.innerHTML = `
              <p class="success">✓ Test passed! User is in BASE_USER's clients list</p>
              <pre>BASE_USER clients: ${JSON.stringify(clients, null, 2)}</pre>
            `;
          } else {
            resultDiv.innerHTML = `
              <p class="error">✗ Test failed: User not found in BASE_USER's clients list</p>
              <pre>BASE_USER clients: ${JSON.stringify(clients, null, 2)}</pre>
            `;
          }
        } else {
          resultDiv.innerHTML = '<p class="error">✗ Test failed: Could not get BASE_USER data</p>';
        }
      } catch (error) {
        resultDiv.innerHTML = `<p class="error">✗ Test failed: ${error.message}</p>`;
      }
    };

    window.testRegisterSecondBaseUser = async function() {
      const resultDiv = document.getElementById('test4-result');
      resultDiv.innerHTML = '<p>Testing...</p>';
      
      try {
        // Get BASE_USER data before registration
        const baseUserUid = simpleHash('base_user').toString();
        const beforeResult = await apiCall('GET', { userId: baseUserUid });
        const clientsCountBefore = beforeResult.data?.clients?.length || 0;
        
        // Register second user
        const testUsername = 'testuser2_' + Date.now();
        const testPassword = 'testpass456';
        
        const result = await Auth.register(testUsername, testPassword, 'user', (msg) => {
          console.log('Register message:', msg);
        });
        
        if (result) {
          testUser2Uid = result.uid;
          
          // Get BASE_USER data after registration
          const afterResult = await apiCall('GET', { userId: baseUserUid });
          const clientsCountAfter = afterResult.data?.clients?.length || 0;
          
          if (clientsCountAfter === clientsCountBefore + 1) {
            resultDiv.innerHTML = `
              <p class="success">✓ Test passed! Second user added to BASE_USER (not recreated)</p>
              <pre>Clients before: ${clientsCountBefore}, after: ${clientsCountAfter}</pre>
              <pre>New user: ${JSON.stringify(result, null, 2)}</pre>
            `;
          } else {
            resultDiv.innerHTML = `
              <p class="error">✗ Test failed: Client count unexpected</p>
              <pre>Clients before: ${clientsCountBefore}, after: ${clientsCountAfter}</pre>
            `;
          }
        } else {
          resultDiv.innerHTML = '<p class="error">✗ Test failed: Registration returned null</p>';
        }
      } catch (error) {
        resultDiv.innerHTML = `<p class="error">✗ Test failed: ${error.message}</p>`;
      }
    };

    window.cleanupTestData = async function() {
      const resultDiv = document.getElementById('cleanup-result');
      resultDiv.innerHTML = '<p>Cleaning up...</p>';
      
      try {
        const deletedUsers = [];
        
        // Delete test users
        if (testUser1Uid) {
          await apiCall('DELETE', { userId: testUser1Uid });
          deletedUsers.push('testUser1');
        }
        if (testUser2Uid) {
          await apiCall('DELETE', { userId: testUser2Uid });
          deletedUsers.push('testUser2');
        }
        
        // Delete BASE_USER
        const baseUserUid = simpleHash('base_user').toString();
        await apiCall('DELETE', { userId: baseUserUid });
        deletedUsers.push('BASE_USER');
        
        resultDiv.innerHTML = `
          <p class="success">✓ Cleanup completed!</p>
          <pre>Deleted: ${deletedUsers.join(', ')}</pre>
        `;
        
        testUser1Uid = null;
        testUser2Uid = null;
      } catch (error) {
        resultDiv.innerHTML = `<p class="error">✗ Cleanup failed: ${error.message}</p>`;
      }
    };
  </script>
</body>
</html>
